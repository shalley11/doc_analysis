# Airgapped deployment - connects to external Redis, Milvus, vLLM
# Set environment variables before running:
#   REDIS_HOST, MILVUS_HOST, VLLM_URL

services:
  # Document Analysis API
  api:
    image: doc-analysis:latest
    build:
      context: .
      dockerfile: Dockerfile
    container_name: doc-analysis-api
    network_mode: host
    command: uvicorn doc_analysis.api:app --host 0.0.0.0 --port 8000 --reload
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - MILVUS_HOST=${MILVUS_HOST:-milvus}
      - MILVUS_PORT=${MILVUS_PORT:-19530}
      - E5_MODEL_PATH=/app/models/e5-large-v2
      - LLM_BACKEND=vllm
      - VLLM_URL=${VLLM_URL:-http://vllm:8000}
      - SUMMARY_MODEL=${SUMMARY_MODEL:-gemma-3-12b-it}
    volumes:
      - /tmp/doc_images:/tmp/doc_images
      # Mount source code for live editing
      - ./api.py:/app/doc_analysis/api.py
      - ./config.py:/app/doc_analysis/config.py
      - ./logging_config.py:/app/doc_analysis/logging_config.py
      - ./chunking:/app/doc_analysis/chunking
      - ./cleanup:/app/doc_analysis/cleanup
      - ./embedding:/app/doc_analysis/embedding
      - ./jobs:/app/doc_analysis/jobs
      - ./pdf:/app/doc_analysis/pdf
      - ./qa:/app/doc_analysis/qa
      - ./queues:/app/doc_analysis/queues
      - ./realtime:/app/doc_analysis/realtime
      - ./summarization:/app/doc_analysis/summarization
      - ./vector_store:/app/doc_analysis/vector_store
      - ./vision:/app/doc_analysis/vision
      - ./workers:/app/doc_analysis/workers
      - ./models:/app/models
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/docs"]
      interval: 30s
      timeout: 10s
      retries: 3

  # RQ Worker for background processing (GPU-enabled)
  worker:
    image: doc-analysis:latest
    depends_on:
      - api
    container_name: doc-analysis-worker
    command: python -m doc_analysis.workers.rq_worker
    environment:
      - REDIS_HOST=${REDIS_HOST:-redis}
      - REDIS_PORT=${REDIS_PORT:-6379}
      - MILVUS_HOST=${MILVUS_HOST:-milvus}
      - MILVUS_PORT=${MILVUS_PORT:-19530}
      - E5_MODEL_PATH=/app/models/e5-large-v2
      - LLM_BACKEND=vllm
      - VLLM_URL=${VLLM_URL:-http://vllm:8000}
      - SUMMARY_MODEL=${SUMMARY_MODEL:-gemma-3-12b-it}
      - NVIDIA_VISIBLE_DEVICES=all
    volumes:
      - /tmp/doc_images:/tmp/doc_images
      # Mount source code for live editing
      - ./api.py:/app/doc_analysis/api.py
      - ./config.py:/app/doc_analysis/config.py
      - ./logging_config.py:/app/doc_analysis/logging_config.py
      - ./chunking:/app/doc_analysis/chunking
      - ./cleanup:/app/doc_analysis/cleanup
      - ./embedding:/app/doc_analysis/embedding
      - ./jobs:/app/doc_analysis/jobs
      - ./pdf:/app/doc_analysis/pdf
      - ./qa:/app/doc_analysis/qa
      - ./queues:/app/doc_analysis/queues
      - ./realtime:/app/doc_analysis/realtime
      - ./summarization:/app/doc_analysis/summarization
      - ./vector_store:/app/doc_analysis/vector_store
      - ./vision:/app/doc_analysis/vision
      - ./workers:/app/doc_analysis/workers
      - ./models:/app/models
    restart: unless-stopped
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: 1
              capabilities: [gpu]
